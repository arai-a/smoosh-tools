#!/bin/sh

# Create a remote branch with generated files, to refer from Cargo.toml in m-c.

set -e

if ! git diff-index --quiet HEAD --; then
   echo "Uncommitted changes found" > /dev/stderr
   exit 1
fi

if ! git diff-index --cached --quiet HEAD --; then
   echo "Uncommitted changes found" > /dev/stderr
   exit 1
fi

BRANCH=$(git rev-parse --abbrev-ref HEAD)

if [ $BRANCH = "HEAD" ]; then
   echo "Detached HEAD is not supported. Please checkout branch" > /dev/stderr
   exit 1
fi

# Switch to the branch for generated.
GEN_BRANCH=${BRANCH}-generated-branch
git checkout -b ${GEN_BRANCH}

# Make generated files
make all

# Commit generated files.
sed -i.bak '/*_generated.rs/d' .gitignore
git add .
git commit -m 'Add generated files'

# Push to remote.
git push -f origin ${GEN_BRANCH}

# Revert the change while keeping the generated files.
git reset --soft HEAD^
mv .gitignore.bak .gitignore
git reset

# Switch back to the original branch.
git checkout ${BRANCH}

# Remove the branch for generated files.
git branch -D ${GEN_BRANCH}
